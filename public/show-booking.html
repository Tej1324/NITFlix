<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Seats - BookMyNIT</title>
  <link rel="stylesheet" href="css/show-booking.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
<!-- Or use PNG -->
<link rel="icon" type="image/png" href="favicon.png" />

  <style>
    .seat.booked, .seat.locked {
      background-color: #aaa !important;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <header><h1><span>Book</span>MyNIT - Seat Booking</h1></header>
  <main>
    <p id="userInfo"></p>
    <div id="seatWrapper"></div>
    <div>SCREEN THIS WAY</div>

    <div class="legend">
      <div class="legend-item"><div class="seat"></div> Available</div>
      <div class="legend-item"><div class="seat selected"></div> Selected</div>
      <div class="legend-item"><div class="seat booked"></div> Booked</div>
    </div>
    <div id="controls">
      <button id="confirmBtn">Confirm Booking</button>
    </div>
  </main>
  <footer><p>&copy; 2025 BookMyNIT. All rights reserved.</p></footer>

  <script type="module">
    import { db, auth, doc, getDoc, setDoc, updateDoc, collection, getDocs, onAuthStateChanged, serverTimestamp } from "./js/firebase.js";

    const seatWrapper = document.getElementById("seatWrapper");
    const confirmBtn = document.getElementById("confirmBtn");
    let selectedSeats = [];
    let currentUser = null;

    const seatLayout = [
      {
        title: 'â‚¹400 ROYALE CLUB',
        priceKey: 'ROYALE CLUB',
        rows: {
          A: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],
          B: [1,2,3,4,5,8,9,10,11,12,13,14,15,16,17,20,21,22]
        }
      },
      {
        title: 'â‚¹300 ROYALE',
        priceKey: 'ROYALE',
        rows: {
          C: [1,2,3,4,5,6,9,10,11,12,13,14,15,16,17,18,19,20,23,24,25,26,27],
          D: [1,2,3,4,5,6,9,10,11,12,13,14,15,16,17,18,19,20,23,24,25,26,27],
          E: [3,4,5,6,9,10,11,12,13,14,15,16,17,18,19,20,23,24,25,26,27]
        }
      },
      {
        title: 'â‚¹250 CLUB',
        priceKey: 'CLUB',
        rows: {
          F: [1,2,3,4,7,8,9,10,11,12,13,14,15,16,17,18,19,20,23,24,25,26,27],
          G: [1,2,3,4,7,8,9,10,11,12,13,14,15,16,17,18,19,20,23,24,25,26,27],
          H: [1,2,3,4,7,8,9,10,11,12,13,14,15,16,17,18,19,20,23,24,25,26,27]
        }
      },
      {
        title: 'â‚¹220 EXECUTIVE',
        priceKey: 'EXECUTIVE',
        rows: {
          I: [1,2,3,4,7,8,9,10,11,12,13,14,15,16,17,18,19,20,23,24,25,26,27],
          J: [1,2,3,4,7,8,9,10,11,12,13,14,15,16,17,18,19,20,23,24,25,26,27]
        }
      }
    ];

    let seatStatusMap = {}; // seatId -> booked/locked

   import { onSnapshot } from "./js/firebase.js";

onAuthStateChanged(auth, (user) => {
  if (!user) return window.location.href = "login.html";
  currentUser = user;
  // Realtime listener to all seats
  onSnapshot(collection(db, "shows", "currentShow", "seats"), (snapshot) => {
  console.log("Snapshot triggered!");
  seatStatusMap = {}; // Reset before rebuild

  snapshot.forEach(seatDoc => {
    const data = seatDoc.data();
    const seatId = seatDoc.id;

    if (data.status === "locked") {
      seatStatusMap[seatId] = "locked";
      seatStatusMap[seatId + "_by"] = data.lockedBy;
    } else if (data.status === "booked") {
      seatStatusMap[seatId] = "booked";
    } else {
      seatStatusMap[seatId] = "available";
    }
  });

  console.log("Rendering with seatStatusMap:", seatStatusMap);
  renderLayout();
});


console.log("Rendering with seatStatusMap:", seatStatusMap);
renderLayout();




          function renderLayout() {
  seatWrapper.innerHTML = ""; // ðŸ’¡ Don't forget to clear the layout before re-rendering

  seatLayout.forEach(section => {
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'section';

    const title = document.createElement('h3');
    title.textContent = section.title;
    sectionDiv.appendChild(title);

    for (const row in section.rows) {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'row';
      const seatNumbers = section.rows[row];
      const maxSeatNum = Math.max(...seatNumbers);

      for (let i = 1; i <= maxSeatNum; i++) {
        if (seatNumbers.includes(i)) {
          const seatId = `${row}${i}`;
          const btn = document.createElement('button');
          btn.className = 'seat';
          btn.textContent = i.toString().padStart(2, '0');
          btn.dataset.seat = seatId;
          btn.dataset.priceKey = section.priceKey;

          const status = seatStatusMap[seatId];

          if (status === 'locked') {
            btn.classList.add('locked');
            btn.disabled = true;
            const lockedByCurrentUser = seatStatusMap[seatId + '_by'] === currentUser.uid;
            btn.title = lockedByCurrentUser
              ? "You have locked this seat."
              : "This seat is temporarily locked by another user.";
          } else if (status === 'booked') {
            btn.classList.add('booked');
            btn.disabled = true;
            btn.title = "This seat is booked.";
          } else {
            btn.classList.remove('locked', 'booked');
            btn.disabled = false;
            btn.title = "Click to select";
            btn.addEventListener('click', () => toggleSeat(btn));
          }

          rowDiv.appendChild(btn);
        } else {
          const gap = document.createElement('div');
          gap.className = 'seat gap';
          rowDiv.appendChild(gap);
        }
      }
      sectionDiv.appendChild(rowDiv);
    }
    seatWrapper.appendChild(sectionDiv);
  });
}


    function toggleSeat(btn) {
  const seatId = btn.dataset.seat;
  const priceKey = btn.dataset.priceKey;

  if (btn.classList.contains("selected")) {
    // Deselect locally
    btn.classList.remove("selected");
    selectedSeats = selectedSeats.filter(s => s.id !== seatId);
  } else {
    // Select locally
    btn.classList.add("selected");
    selectedSeats.push({ id: seatId, priceKey });
  }

  // Optional: update price/seat count UI
  updateSummary?.(); // only call if function exists
}


  confirmBtn.addEventListener("click", async () => {
  if (selectedSeats.length === 0) {
    alert("Select at least one seat.");
    return;
  }

  try {
    for (const seat of selectedSeats) {
      const seatRef = doc(db, "shows", "currentShow", "seats", seat.id);
      await updateDoc(seatRef, {
        status: "locked",
        lockedBy: currentUser.uid,
        lockedAt: serverTimestamp()
      });
    }

    sessionStorage.setItem("selectedSeats", JSON.stringify(selectedSeats));
    window.location.href = "payment.html";
  } catch (err) {
    alert("Failed to lock some seats. Please try again.");
    console.error(err);
  }
});


});

  </script>
</body>
</html>